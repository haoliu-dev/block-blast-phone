# Block Blast 游戏需求文档

本文档定义了 Block Blast（方块消除）益智游戏 Web 应用的所有功能需求和非功能需求，面向支持触屏的移动设备。

---

## 1. 游戏概述

### 1.1 核心概念
- **游戏类型**: 方块拼图 / 瓦片匹配益智游戏
- **游戏玩法**: 将彩色方块形状拖放到网格上，填充完整的行或列进行消除并得分
- **目标**: 在空间耗尽前获得最高分
- **平台**: 移动端 Web 浏览器（触屏优先设计）

### 1.2 目标用户
- 适合所有年龄段的休闲玩家
- 寻求放松、脑力训练益智游戏的玩家
- 偏好触屏交互的移动端用户

---

## 2. 游戏机制

### 2.1 网格系统
- **棋盘尺寸**: 8x8 网格（Block Blast 标准尺寸）
- **格子状态**: 空或被方块占用
- **坐标系**: (行, 列)，(0,0) 为左上角

### 2.2 方块形状
- **多联骨牌类型**:
  - 单格 (1x1)
  - 双格 (1x2, 2x1)
  - L 形 (2x2 缺一角)
  - T 形
  - 正方形 (2x2, 3x3)
  - 线段 (1x3, 1x4, 1x5)
  - Z 形 / S 形
- **形状生成**: 从定义好的形状池中随机选择
- **生成数量**: 每次生成 3 个形状
- **形状回收**: 只有当 3 个形状全部放置后才会生成新的一组

### 2.3 放置规则
- 方块只能放置在空格子内
- 方块必须完全在网格边界内
- 从生成区拖动到目标位置
- 视觉预览显示有效/无效放置

### 2.4 行/列消除
- **触发条件**: 完整的一行（横向）或一列（纵向）被填满
- **消除动作**: 清除完成行/列的所有格子
- **多行消除**: 同时消除多行可获得额外加分
- **动画效果**: 消除时提供令人愉悦的视觉效果

### 2.5 得分系统
- **基础分**: 每放置一个方块得 10 分
- **行列消除**: 每一行/列得 100 分
- **连击倍数**:
  - 2 行: 1.5 倍
  - 3 行: 2 倍
  - 4 行及以上: 2.5 倍
- **连续操作**: 连续成功放置（未消除）可获得奖励分

### 2.6 游戏结束条件
- **触发条件**: 没有任何剩余形状可以放置在棋盘任意位置
- **检测时机**: 每次放置后检查当前 3 个可用形状是否能放入
- **显示**: 游戏结束界面，显示最终分数和重新开始选项

---

## 3. 触屏交互需求

### 3.1 手势支持
- **拖拽**: 从生成区触屏拖动方块形状到网格
- **点击**: 选择 UI 按钮（开始、重新开始、设置）
- **滑动**: 核心玩法不需要滑动，但不应干扰正常操作

### 3.2 触屏事件处理
- 必须使用 `pointerdown` / `pointermove` / `pointerup` 或 `touchstart` / `touchend`
- 支持触屏和鼠标输入
- 阻止默认浏览器行为（滚动、缩放、下拉刷新）
- **防止双击缩放**: 使用 `touch-action: none` 和 `user-select: none`

### 3.3 拖拽行为
- 拖拽时方块形状跟随手指/光标
- 在网格上显示幽灵预览指示放置位置
- 绿色高亮表示有效放置，红色表示无效
- 释放时吸附到最近的 valid 网格位置
- 如果放置无效，返回到生成区位置

### 3.4 触屏目标尺寸
- 最小触屏目标尺寸: 44x44 CSS 像素
- 交互元素之间保持适当间距，防止误触
- 生成区方块尺寸适当，便于移动端拖拽

---

## 4. 用户界面

### 4.1 屏幕

#### 4.1.1 开始屏幕
- 游戏标题/Logo
- "开始游戏" 按钮
- 最高分显示（如有）
- 设置入口

#### 4.1.2 游戏屏幕
- 8x8 游戏网格（主区域）
- 分数显示（当前分数）
- 消除行数计数器
- 形状生成区（屏幕底部）
- 暂停/菜单按钮

#### 4.1.3 游戏结束屏幕
- "游戏结束" 提示
- 最终分数显示
- 最高分（如是新纪录，显示 "新纪录！"）
- "再玩一次" 按钮
- "主菜单" 按钮

#### 4.1.4 暂停屏幕（可选）
- "已暂停" 提示
- 继续按钮
- 重新开始按钮
- 设置按钮
- 主菜单按钮

### 4.2 UI 组件

#### 4.2.1 按钮
- 最小尺寸: 48x48 CSS 像素
- 按下时有清晰的视觉反馈（缩放或颜色变化）
- 状态: 默认、悬停（桌面端）、按下/激活、禁用
- **必须添加 `data-testid` 属性** - 所有交互元素（按钮、弹窗等）必须有测试标识

#### 4.2.2 分数显示
- 字体大且清晰易读
- 分数增加时带动画
- 位置: 顶部区域，不遮挡游戏区域

#### 4.2.3 形状生成区
- 固定在屏幕底部
- 显示 3 个可用形状
- 形状不重叠
- 小屏幕上可水平滚动

### 4.3 视觉设计

#### 4.3.1 配色方案
- **背景**: 深色或中性色，使方块更突出
- **网格**: 柔和的网格线，比背景稍深
- **方块颜色**: 鲜艳、可区分的颜色（红、蓝、绿、黄、橙、紫、青）
- **UI 元素**: 按钮和高亮使用一致的强调色
- **有效/无效指示**: 绿色表示有效，红色表示无效

#### 4.3.2 字体
- 清晰易读的无衬线字体
- 分数: 粗体、大号（24-32px 等效）
- 按钮: 中等字重、足够大小（16-18px 等效）
- 高对比度文本确保可读性

#### 4.3.3 动画
- 方块放置动画（快速、令人满足）
- 行列消除动画（闪烁 + 淡出）
- 分数增加动画（数字滚动）
- 按钮按下反馈
- 游戏结束过渡

---

## 5. 技术需求

### 5.1 技术栈
- **运行时**: Bun（必须使用 `bun install` 和 `bun test`）
- **语言**: TypeScript（严格模式）
- **禁止使用 `any`**: 复杂状态必须定义 `interface`
- **模块化**: 游戏逻辑必须与渲染层解耦，以便进行纯逻辑单元测试
- **渲染**: HTML5 Canvas 或 DOM（Canvas 优先以获得更好性能）
- **测试**: Playwright 用于 E2E，Bun 用于单元测试

### 5.2 性能需求
- **帧率**: 游戏过程中保持 60 FPS
- **加载时间**: 4G 网络下初始加载不超过 3 秒
- **触屏延迟**: 响应时间不超过 100ms
- **内存**: 高效使用资源，无内存泄漏

### 5.3 浏览器兼容性
- Chrome (移动端) 61+
- Safari (iOS) 13+
- Firefox Mobile
- Samsung Internet

### 5.4 视口与响应式设计
- 正确的移动端 viewport meta 标签
- 适应屏幕宽度，无水平滚动
- 处理屏幕方向变化（竖屏为主）
- 禁止缩放和双击缩放
- 适配刘海屏设备的安全区域

### 5.5 离线支持
- Service Worker 缓存（可选但推荐）
- 首次加载后游戏应可离线运行

---

## 6. 数据持久化

### 6.1 本地存储
- **最高分**: 使用 localStorage 持久化
- **设置**: 存储用户偏好（声音开关等）

### 6.2 数据结构
```typescript
interface GameData {
  highScore: number;
  settings: {
    soundEnabled: boolean;
    vibrationEnabled: boolean;
  };
}
```

---

## 7. 音频（可选增强）

### 7.1 音效
- 方块放置音效
- 行列消除音效
- 连击音效
- 游戏结束音效

### 7.2 音乐
- 背景音乐开关
- 默认: 关闭（尊重用户偏好）

### 7.3 实现方式
- 使用 Web Audio API 或 HTML5 Audio
- 懒加载音频文件
- 设置中提供静音选项

---

## 8. 无障碍

### 8.1 基础无障碍
- 足够的颜色对比度
- 触屏目标满足最小尺寸要求
- 不单独依赖颜色传递信息

### 8.2 屏幕阅读器支持（未来增强）
- UI 元素使用语义化 HTML
- 交互元素添加 ARIA 标签
- 初始版本不强制要求，但考虑未来支持

---

## 9. 测试需求

### 9.1 逻辑单元测试 (Logic Unit Test)
- **路径**: `src/**/*.test.ts`
- **执行**: 使用 `bun test`
- **覆盖点**: 核心算法（得分计算、碰撞检测、状态机转换）

### 9.2 交互测试 (Playwright E2E)
- **路径**: `tests/e2e/*.spec.ts`
- **强制配置**: 必须模拟移动端环境（如 `iPhone 14` 或 `Pixel 7`）
- **核心流程**:
  1. **加载测试**: 验证首屏资源及 Canvas 加载成功
  2. **手势测试**: 模拟 `tap`, `swipe`, `drag` 等操作
  3. **逻辑闭环**: 点击"开始" -> 游戏状态变更 -> 死亡判定 -> 弹出结算面板

### 9.3 测试标识
- 所有交互元素必须添加 `data-testid` 属性
- 示例: `<button data-testid="game-start-button">Play</button>`

---

## 10. 未来增强（超出范围）

- 多种游戏模式（限时、冒险）
- 每日挑战
- 排行榜
- 社交分享
- 主题/皮肤
- 道具/加成
- 音效和音乐

---

## 11. 验收标准

### 11.1 核心玩法
- [ ] 游戏棋盘正确渲染为 8x8 网格
- [ ] 生成区出现 3 个随机形状
- [ ] 形状可以拖放到网格上
- [ ] 无效放置会被拒绝并有视觉反馈
- [ ] 完成的行/列会被消除
- [ ] 分数根据放置和消除正确更新
- [ ] 无法移动时触发游戏结束
- [ ] 游戏可以重新开始

### 11.2 触屏交互
- [ ] 移动端触屏拖拽流畅
- [ ] 游戏过程中无意外滚动
- [ ] 禁用缩放
- [ ] 禁用双击缩放

### 11.3 性能
- [ ] 中端移动设备上运行帧率达 60 FPS
- [ ] 触屏响应即时（<100ms）
- [ ] 长时间游玩无内存泄漏

### 11.4 数据持久化
- [ ] 最高分正确保存和读取
- [ ] 设置在会话间持久化

### 11.5 视觉
- [ ] UI 在移动端屏幕上可读
- [ ] 动画流畅
- [ ] 游戏适应视口，无滚动
